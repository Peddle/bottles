@b move the bulk of the code here
